<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Whisper Live Log</title>
</head>
<body>
  <h1>Whisper Live Transcription Log</h1>

  <button id="initBtn">Init Whisper</button>
  <button id="startBtn">Start Listening</button>
  <button id="stopBtn">Stop Listening</button>
  <button id="popUp">Show PopUp</button>

  <pre id="transcriptionLog" style="max-height: 2000px; overflow-y: scroll;"></pre>

  <script type="module">
    import { SpeechConverterOnline } from './src/SpeechConverterOnline.js';
    import {showHistoryPopup } from './src/showHistoryPopup.js';
    import { CommandMapping } from './src/commandMapping.js';
    

    document.getElementById("popUp").onclick = () => showHistoryPopup();

    const sc = new SpeechConverterOnline();
    const logEl = document.getElementById("transcriptionLog");
    let pollingId = null;
    let lastTextIndex = 0;
    let lastText = ""; // last transcription

    // Initialize command mapping and add test commands 
    const commandMapper = new CommandMapping();
    
    commandMapper.addCommand(
      'clear',
      () => {
        document.body.style.backgroundColor = 'white';
      },
      {
        description: 'Clears the background color',
        active: true
      }
    );

    commandMapper.addCommand(
      'red',
      () => {
        document.body.style.backgroundColor = 'red';
      },
      {
        description: 'Changes the background color to red',
        active: true
      }
    );

    commandMapper.addCommand(
      'green',
      () => {
        document.body.style.backgroundColor = 'green';
      },
      {
        description: 'Changes the background color to green',
        active: true
      }
    );

    document.getElementById("initBtn").onclick = async () => {
      try {
        let htmlLink = 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin';
        let localPath = '/models/ggml-tiny.en.bin';
        await sc.init(htmlLink, 'en'); 
        logEl.textContent += "[System] Whisper initialized.\n";
      } catch (e) {
        logEl.textContent += "[Error] Init failed: " + e + "\n";
      }
    };

    document.getElementById("startBtn").onclick = async () => {
      try {
        sc.startListening();
        logEl.textContent += "[System] Started listening...\n";

        // start polling every 2 seconds for transcriptions
      let lastSeen = "";
      if (!pollingId) {
        pollingId = window.setInterval(() => {
          const logs = sc.getTextLog();
          const latest = logs[logs.length -1];
          if(latest && lastSeen != latest){
            logEl.textContent += latest
            lastSeen =latest;
        }
        }, 200);
      }

      } catch (err) {
        logEl.textContent += "[Error] Start listening failed: " + err + "\n";
      }
    };

    document.getElementById("stopBtn").onclick = async () => {
        try{
          sc.stopListening();
          logEl.textContent += "[System] Stopped listening...\n";
        }
        catch(err){
          logEl.textContent += "[Error] Stop listening failed: " + err + "\n";
        }
      


    }

  </script>
</body>
</html>
